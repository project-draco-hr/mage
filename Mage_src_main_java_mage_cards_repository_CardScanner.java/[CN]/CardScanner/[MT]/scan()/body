{
  if (scanned) {
    return;
  }
  scanned=true;
  List<CardInfo> cardsToAdd=new ArrayList<>();
  Map<ClassLoader,List<String>> packageMap=new HashMap<>();
  for (  ExpansionSet set : Sets.getInstance().values()) {
    ClassLoader cl=set.getClass().getClassLoader();
    if (!packageMap.containsKey(cl))     packageMap.put(cl,new ArrayList<String>());
    List<String> packages=packageMap.get(cl);
    packages.add(set.getPackageName());
    ExpansionRepository.instance.add(new ExpansionInfo(set));
  }
  ExpansionRepository.instance.setContentVersion(ExpansionRepository.instance.getContentVersionConstant());
  for (  ClassLoader cl : packageMap.keySet()) {
    for (    Class c : ClassScanner.findClasses(cl,packageMap.get(cl),CardImpl.class)) {
      if (!CardRepository.instance.cardExists(c.getCanonicalName())) {
        Card card=CardImpl.createCard(c);
        if (card != null) {
          cardsToAdd.add(new CardInfo(card));
          if (card instanceof SplitCard) {
            SplitCard splitCard=(SplitCard)card;
            cardsToAdd.add(new CardInfo(splitCard.getLeftHalfCard()));
            cardsToAdd.add(new CardInfo(splitCard.getRightHalfCard()));
          }
        }
      }
    }
  }
  if (!cardsToAdd.isEmpty()) {
    logger.info("Cards need storing in DB: " + cardsToAdd.size());
    CardRepository.instance.addCards(cardsToAdd);
  }
  CardRepository.instance.setContentVersion(CardRepository.instance.getContentVersionConstant());
}
