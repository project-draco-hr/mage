{
  if (!message.isEmpty()) {
    final String msg=message;
    final String time=(withTime ? timeFormatter.format(cal.getTime()) : "");
    final String username=userName;
    logger.debug("Broadcasting '" + msg + "' for "+ chatId);
    for (    UUID userId : clients.keySet()) {
      User user=UserManager.getInstance().getUser(userId);
      if (user != null) {
        user.fireCallback(new ClientCallback("chatMessage",chatId,new ChatMessage(username,msg,time,color,messageType,soundToPlay)));
      }
 else {
        kill(userId,User.DisconnectReason.CleaningUp);
      }
    }
  }
}
