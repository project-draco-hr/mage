{
  if (!message.isEmpty()) {
    final String msg=message;
    final String time=(withTime ? timeFormatter.format(new Date()) : "");
    final String username=userName;
    logger.trace("Broadcasting '" + msg + "' for "+ chatId);
    for (    UUID userId : clients.keySet()) {
      User user=UserManager.getInstance().getUser(userId);
      if (user != null) {
        user.fireCallback(new ClientCallback("chatMessage",chatId,new ChatMessage(username,msg,time,color,messageType,soundToPlay)));
      }
 else {
        logger.debug("ChatSession.broadcast user not found - killed from chat session - userId: " + userId + "  chatId: "+ chatId);
        kill(userId,DisconnectReason.CleaningUp);
      }
    }
  }
}
