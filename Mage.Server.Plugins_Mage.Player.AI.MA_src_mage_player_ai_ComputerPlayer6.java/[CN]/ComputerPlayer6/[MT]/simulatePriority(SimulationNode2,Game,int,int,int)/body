{
  if (Thread.interrupted()) {
    Thread.currentThread().interrupt();
    logger.info("interrupted");
    return GameStateEvaluator2.evaluate(playerId,game);
  }
  node.setGameValue(game.getState().getValue().hashCode());
  SimulatedPlayer2 currentPlayer=(SimulatedPlayer2)game.getPlayer(game.getPlayerList().get());
  SimulationNode2 bestNode=null;
  List<Ability> allActions=currentPlayer.simulatePriority(game);
  optimize(game,allActions);
  logger.debug("simulating -- adding " + allActions.size() + " children:"+ allActions);
  for (  Ability action : allActions) {
    if (Thread.interrupted()) {
      Thread.currentThread().interrupt();
      logger.debug("interrupted");
      break;
    }
    Game sim=game.copy();
    if (sim.getPlayer(currentPlayer.getId()).activateAbility((ActivatedAbility)action.copy(),sim)) {
      sim.applyEffects();
      if (checkForRepeatedAction(sim,node,action,currentPlayer.getId()))       continue;
      if (!sim.isGameOver() && action.isUsesStack()) {
        sim.getPlayer(currentPlayer.getId()).pass();
        sim.getPlayerList().getNext();
      }
      SimulationNode2 newNode=new SimulationNode2(node,sim,action,depth,currentPlayer.getId());
      logger.debug("simulating -- node #:" + SimulationNode2.getCount() + " actions:"+ action);
      sim.checkStateAndTriggered();
      int val=addActions(newNode,depth - 1,alpha,beta);
      logger.debug("val = " + val);
      if (!currentPlayer.getId().equals(playerId)) {
        if (val < beta) {
          beta=val;
          bestNode=newNode;
          bestNode.setScore(val);
          if (newNode.getChildren().size() > 0) {
            bestNode.setCombat(newNode.getChildren().get(0).getCombat());
          }
        }
        if (val == GameStateEvaluator2.LOSE_GAME_SCORE) {
          logger.debug("lose - break");
          break;
        }
      }
 else {
        if (val > alpha) {
          alpha=val;
          bestNode=newNode;
          bestNode.setScore(val);
          if (newNode.getChildren().size() > 0) {
            bestNode.setCombat(newNode.getChildren().get(0).getCombat());
          }
          if (depth == maxDepth) {
            logger.info("saved");
            node.children.clear();
            node.children.add(bestNode);
            node.setScore(bestNode.getScore());
          }
        }
        if (val == GameStateEvaluator2.WIN_GAME_SCORE) {
          logger.debug("win - break");
          break;
        }
      }
      if (alpha >= beta) {
        logger.info("simulating -- pruning");
        break;
      }
      if (SimulationNode2.nodeCount > maxNodes) {
        logger.debug("simulating -- reached end-state");
        break;
      }
    }
  }
  if (bestNode != null) {
    node.children.clear();
    node.children.add(bestNode);
    node.setScore(bestNode.getScore());
  }
  if (!currentPlayer.getId().equals(playerId)) {
    logger.info("returning priority beta: " + beta);
    return beta;
  }
 else {
    logger.info("returning priority alpha: " + alpha);
    return alpha;
  }
}
