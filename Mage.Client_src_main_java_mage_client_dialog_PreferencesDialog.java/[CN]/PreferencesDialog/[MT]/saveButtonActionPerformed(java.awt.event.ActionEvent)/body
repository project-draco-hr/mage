{
  Preferences prefs=MageFrame.getPreferences();
  save(prefs,dialog.showToolTipsInAnyZone,KEY_SHOW_TOOLTIPS_ANY_ZONE,"true","false",UPDATE_CACHE_POLICY);
  save(prefs,dialog.displayBigCardsInHand,KEY_HAND_USE_BIG_CARDS,"true","false",UPDATE_CACHE_POLICY);
  save(prefs,dialog.nonLandPermanentsInOnePile,KEY_PERMANENTS_IN_ONE_PILE,"true","false",UPDATE_CACHE_POLICY);
  save(prefs,dialog.checkBoxUpkeepYou,UPKEEP_YOU);
  save(prefs,dialog.checkBoxDrawYou,DRAW_YOU);
  save(prefs,dialog.checkBoxMainYou,MAIN_YOU);
  save(prefs,dialog.checkBoxBeforeCYou,BEFORE_COMBAT_YOU);
  save(prefs,dialog.checkBoxEndOfCYou,END_OF_COMBAT_YOU);
  save(prefs,dialog.checkBoxMain2You,MAIN_2_YOU);
  save(prefs,dialog.checkBoxEndTurnYou,END_OF_TURN_YOU);
  save(prefs,dialog.checkBoxUpkeepOthers,UPKEEP_OTHERS);
  save(prefs,dialog.checkBoxDrawOthers,DRAW_OTHERS);
  save(prefs,dialog.checkBoxMainOthers,MAIN_OTHERS);
  save(prefs,dialog.checkBoxBeforeCOthers,BEFORE_COMBAT_OTHERS);
  save(prefs,dialog.checkBoxEndOfCOthers,END_OF_COMBAT_OTHERS);
  save(prefs,dialog.checkBoxMain2Others,MAIN_2_OTHERS);
  save(prefs,dialog.checkBoxEndTurnOthers,END_OF_TURN_OTHERS);
  save(prefs,dialog.useDefaultImageFolder,KEY_CARD_IMAGES_USE_DEFAULT,"true","false",UPDATE_CACHE_POLICY);
  saveImagesPath(prefs);
  save(prefs,dialog.checkForNewImages,KEY_CARD_IMAGES_CHECK,"true","false",UPDATE_CACHE_POLICY);
  save(prefs,dialog.saveToZipFiles,KEY_CARD_IMAGES_SAVE_TO_ZIP,"true","false",UPDATE_CACHE_POLICY);
  save(prefs,dialog.cbProxyType,KEY_PROXY_TYPE);
  save(prefs,dialog.txtProxyServer,KEY_PROXY_ADDRESS);
  save(prefs,dialog.txtProxyPort,KEY_PROXY_PORT);
  save(prefs,dialog.txtProxyUserName,KEY_PROXY_USERNAME);
  save(prefs,dialog.rememberPswd,KEY_PROXY_REMEMBER,"true","false",UPDATE_CACHE_POLICY);
  if (dialog.rememberPswd.isSelected()) {
    char[] input=txtPasswordField.getPassword();
    prefs.put(KEY_PROXY_PSWD,new String(input));
  }
  if (availableAvatars.contains(selectedId)) {
    prefs.put(KEY_AVATAR,String.valueOf(selectedId));
    updateCache(KEY_AVATAR,String.valueOf(selectedId));
  }
  try {
    prefs.flush();
  }
 catch (  BackingStoreException ex) {
    ex.printStackTrace();
    JOptionPane.showMessageDialog(null,"Error: couldn't save preferences. Please try once again.");
  }
  dialog.setVisible(false);
}
