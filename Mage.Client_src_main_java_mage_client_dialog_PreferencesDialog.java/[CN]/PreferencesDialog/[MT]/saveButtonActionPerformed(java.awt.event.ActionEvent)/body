{
  Preferences prefs=MageFrame.getPreferences();
  save(prefs,dialog.showToolTipsInAnyZone,KEY_SHOW_TOOLTIPS_ANY_ZONE,"true","false",UPDATE_CACHE_POLICY);
  save(prefs,dialog.displayBigCardsInHand,KEY_HAND_USE_BIG_CARDS,"true","false",UPDATE_CACHE_POLICY);
  save(prefs,dialog.nonLandPermanentsInOnePile,KEY_PERMANENTS_IN_ONE_PILE,"true","false",UPDATE_CACHE_POLICY);
  save(prefs,dialog.showPlayerNamesPermanently,KEY_SHOW_PLAYER_NAMES_PERMANENTLY,"true","false",UPDATE_CACHE_POLICY);
  save(prefs,dialog.showAbilityPickerForced,KEY_SHOW_ABILITY_PICKER_FORCED,"true","false",UPDATE_CACHE_POLICY);
  save(prefs,dialog.cbGameLogAutoSave,KEY_GAME_LOG_AUTO_SAVE,"true","false",UPDATE_CACHE_POLICY);
  save(prefs,dialog.checkBoxUpkeepYou,PhaseManager.UPKEEP_YOU);
  save(prefs,dialog.checkBoxDrawYou,PhaseManager.DRAW_YOU);
  save(prefs,dialog.checkBoxMainYou,PhaseManager.MAIN_YOU);
  save(prefs,dialog.checkBoxBeforeCYou,PhaseManager.BEFORE_COMBAT_YOU);
  save(prefs,dialog.checkBoxEndOfCYou,PhaseManager.END_OF_COMBAT_YOU);
  save(prefs,dialog.checkBoxMain2You,PhaseManager.MAIN_2_YOU);
  save(prefs,dialog.checkBoxEndTurnYou,PhaseManager.END_OF_TURN_YOU);
  save(prefs,dialog.checkBoxUpkeepOthers,PhaseManager.UPKEEP_OTHERS);
  save(prefs,dialog.checkBoxDrawOthers,PhaseManager.DRAW_OTHERS);
  save(prefs,dialog.checkBoxMainOthers,PhaseManager.MAIN_OTHERS);
  save(prefs,dialog.checkBoxBeforeCOthers,PhaseManager.BEFORE_COMBAT_OTHERS);
  save(prefs,dialog.checkBoxEndOfCOthers,PhaseManager.END_OF_COMBAT_OTHERS);
  save(prefs,dialog.checkBoxMain2Others,PhaseManager.MAIN_2_OTHERS);
  save(prefs,dialog.checkBoxEndTurnOthers,PhaseManager.END_OF_TURN_OTHERS);
  save(prefs,dialog.cbUseDefaultImageFolder,KEY_CARD_IMAGES_USE_DEFAULT,"true","false",UPDATE_CACHE_POLICY);
  saveImagesPath(prefs);
  save(prefs,dialog.cbCheckForNewImages,KEY_CARD_IMAGES_CHECK,"true","false",UPDATE_CACHE_POLICY);
  save(prefs,dialog.cbSaveToZipFiles,KEY_CARD_IMAGES_SAVE_TO_ZIP,"true","false",UPDATE_CACHE_POLICY);
  save(prefs,dialog.cbPreferedImageLanguage,KEY_CARD_IMAGES_PREF_LANGUAGE);
  save(prefs,dialog.cbUseDefaultBackground,KEY_BACKGROUND_IMAGE_DEFAULT,"true","false",UPDATE_CACHE_POLICY);
  save(prefs,dialog.cbUseDefaultBattleImage,KEY_BATTLEFIELD_IMAGE_DEFAULT,"true","false",UPDATE_CACHE_POLICY);
  save(prefs,dialog.cbUseRandomBattleImage,KEY_BATTLEFIELD_IMAGE_RANDOM,"true","false",UPDATE_CACHE_POLICY);
  save(prefs,dialog.cbEnableGameSounds,KEY_SOUNDS_GAME_ON,"true","false",UPDATE_CACHE_POLICY);
  save(prefs,dialog.cbEnableOtherSounds,KEY_SOUNDS_OTHER_ON,"true","false",UPDATE_CACHE_POLICY);
  save(prefs,dialog.cbEnableBattlefieldBGM,KEY_SOUNDS_MATCH_MUSIC_ON,"true","false",UPDATE_CACHE_POLICY);
  saveSoundPath(prefs);
  save(prefs,dialog.cbProxyType,KEY_PROXY_TYPE);
  save(prefs,dialog.txtProxyServer,KEY_PROXY_ADDRESS);
  save(prefs,dialog.txtProxyPort,KEY_PROXY_PORT);
  save(prefs,dialog.txtProxyUserName,KEY_PROXY_USERNAME);
  save(prefs,dialog.rememberPswd,KEY_PROXY_REMEMBER,"true","false",UPDATE_CACHE_POLICY);
  if (dialog.rememberPswd.isSelected()) {
    char[] input=txtPasswordField.getPassword();
    prefs.put(KEY_PROXY_PSWD,new String(input));
  }
  if (available_avatars.contains(selectedAvatarId)) {
    prefs.put(KEY_AVATAR,String.valueOf(selectedAvatarId));
    updateCache(KEY_AVATAR,String.valueOf(selectedAvatarId));
  }
  try {
    MageFrame.getSession().updatePreferencesForServer(getSelectedAvatar(),dialog.showAbilityPickerForced.isSelected());
    prefs.flush();
  }
 catch (  BackingStoreException ex) {
    ex.printStackTrace();
    JOptionPane.showMessageDialog(null,"Error: couldn't save preferences. Please try once again.");
  }
  dialog.setVisible(false);
}
