{
  Player controller=game.getPlayer(source.getControllerId());
  UUID target=source.getFirstTarget();
  if (controller != null && target != null) {
    Choice choiceImpl=new ChoiceImpl();
    choiceImpl.setMessage("Choose card type to tap or untap");
    choiceImpl.setChoices(choice);
    while (!controller.choose(Outcome.Neutral,choiceImpl,game)) {
      if (!controller.isInGame()) {
        return false;
      }
    }
    CardType type;
    String choosenType=choiceImpl.getChoice();
    if (choosenType.equals(CardType.ARTIFACT.toString())) {
      type=CardType.ARTIFACT;
    }
 else     if (choosenType.equals(CardType.LAND.toString())) {
      type=CardType.LAND;
    }
 else {
      type=CardType.CREATURE;
    }
    choiceImpl=new ChoiceImpl();
    choiceImpl.setMessage("Choose to tap or untap");
    choiceImpl.setChoices(choice2);
    while (!controller.choose(Outcome.Neutral,choiceImpl,game)) {
      if (!controller.isInGame()) {
        return false;
      }
    }
    FilterPermanent filter=new FilterPermanent();
    filter.add(new CardTypePredicate(type));
    if (choiceImpl.getChoice().equals("Untap")) {
      filter.add(new TappedPredicate());
      for (      Permanent permanent : game.getBattlefield().getActivePermanents(filter,source.getControllerId(),source.getSourceId(),game)) {
        if (permanent.getControllerId().equals(target)) {
          permanent.untap(game);
        }
      }
    }
 else {
      filter.add(Predicates.not(new TappedPredicate()));
      for (      Permanent permanent : game.getBattlefield().getActivePermanents(filter,source.getControllerId(),source.getSourceId(),game)) {
        if (permanent.getControllerId().equals(target)) {
          permanent.tap(game);
        }
      }
    }
  }
  return true;
}
