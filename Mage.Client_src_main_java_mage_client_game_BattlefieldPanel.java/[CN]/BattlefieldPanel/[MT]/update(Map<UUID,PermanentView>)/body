{
  boolean changed=false;
  for (  PermanentView permanent : battlefield.values()) {
    if (!permanents.containsKey(permanent.getId())) {
      addPermanent(permanent);
      changed=true;
    }
 else {
      MagePermanent p=permanents.get(permanent.getId());
      if (!changed) {
        int s1=permanent.getAttachments() == null ? 0 : permanent.getAttachments().size();
        int s2=p.getLinks().size();
        if (s1 != s2) {
          changed=true;
        }
      }
      permanents.get(permanent.getId()).update(permanent);
    }
  }
  for (Iterator<Entry<UUID,MagePermanent>> i=permanents.entrySet().iterator(); i.hasNext(); ) {
    Entry<UUID,MagePermanent> entry=i.next();
    if (!battlefield.containsKey(entry.getKey())) {
      removePermanent(entry.getKey());
      i.remove();
      changed=true;
    }
  }
  if (changed) {
    BattlefieldPanel.battlefield=battlefield;
    sortLayout();
synchronized (this) {
      for (      Thread t : threads) {
        t.start();
      }
      threads.clear();
    }
  }
}
