{
  for (  PermanentView permanent : battlefield.values()) {
    if (!permanents.containsKey(permanent.getId())) {
      addPermanent(permanent);
    }
 else {
      permanents.get(permanent.getId()).update(permanent);
    }
  }
  for (Iterator<Entry<UUID,MagePermanent>> i=permanents.entrySet().iterator(); i.hasNext(); ) {
    Entry<UUID,MagePermanent> entry=i.next();
    if (!battlefield.containsKey(entry.getKey())) {
      removePermanent(entry.getKey());
      i.remove();
    }
  }
  for (  PermanentView permanent : battlefield.values()) {
    if (permanent.getAttachments() != null) {
      groupAttachments(permanent);
    }
  }
  Plugins.getInstance().sortPermanents(ui,permanents.values());
  invalidate();
}
