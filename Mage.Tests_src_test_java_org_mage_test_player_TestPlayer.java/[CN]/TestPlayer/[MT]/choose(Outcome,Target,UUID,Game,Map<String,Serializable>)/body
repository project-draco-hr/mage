{
  if (!choices.isEmpty()) {
    if ((target instanceof TargetPermanent) || (target instanceof TargetPermanentOrPlayer)) {
      FilterPermanent filterPermanent;
      if (target instanceof TargetPermanentOrPlayer) {
        filterPermanent=((TargetPermanentOrPlayer)target).getFilterPermanent();
      }
 else {
        filterPermanent=((TargetPermanent)target).getFilter();
      }
      for (      String choose2 : choices) {
        String[] targetList=choose2.split("\\^");
        boolean targetFound=false;
        for (        String targetName : targetList) {
          for (          Permanent permanent : game.getBattlefield().getAllActivePermanents(filterPermanent,game)) {
            if (target.getTargets().contains(permanent.getId())) {
              continue;
            }
            if (permanent.getName().equals(targetName)) {
              if (target.isNotTarget() || ((TargetPermanent)target).canTarget(playerId,permanent.getId(),null,game)) {
                target.add(permanent.getId(),game);
                targetFound=true;
                break;
              }
            }
 else             if ((permanent.getName() + "-" + permanent.getExpansionSetCode()).equals(targetName)) {
              if (target.isNotTarget() || ((TargetPermanent)target).canTarget(playerId,permanent.getId(),null,game)) {
                target.add(permanent.getId(),game);
                targetFound=true;
                break;
              }
            }
          }
        }
        if (targetFound) {
          choices.remove(choose2);
          return true;
        }
      }
    }
    if (target instanceof TargetPlayer) {
      for (      Player player : game.getPlayers().values()) {
        for (        String choose2 : choices) {
          if (player.getName().equals(choose2)) {
            if (((TargetPlayer)target).canTarget(playerId,player.getId(),null,game) && !target.getTargets().contains(player.getId())) {
              target.add(player.getId(),game);
              choices.remove(choose2);
              return true;
            }
          }
        }
      }
    }
    if (target instanceof TargetSource) {
      Set<UUID> possibleTargets;
      TargetSource t=((TargetSource)target);
      possibleTargets=t.possibleTargets(sourceId,playerId,game);
      for (      UUID targetId : possibleTargets) {
        MageObject targetObject=game.getObject(targetId);
        if (targetObject != null) {
          for (          String choose2 : choices) {
            String[] targetList=choose2.split("\\^");
            boolean targetFound=false;
            for (            String targetName : targetList) {
              if (targetObject.getName().equals(targetName)) {
                List<UUID> alreadyTargetted=target.getTargets();
                if (t.canTarget(targetObject.getId(),game)) {
                  if (alreadyTargetted != null && !alreadyTargetted.contains(targetObject.getId())) {
                    target.add(targetObject.getId(),game);
                    choices.remove(choose2);
                    targetFound=true;
                  }
                }
              }
            }
            if (targetFound) {
              choices.remove(choose2);
              return true;
            }
          }
        }
      }
    }
  }
  return super.choose(outcome,target,sourceId,game,options);
}
