{
  if (txtUserName.getText().isEmpty()) {
    JOptionPane.showMessageDialog(rootPane,"Please provide a user name");
    return;
  }
  if (txtServer.getText().trim().isEmpty()) {
    JOptionPane.showMessageDialog(rootPane,"Please provide a server address");
    return;
  }
  if (txtPort.getText().trim().isEmpty()) {
    JOptionPane.showMessageDialog(rootPane,"Please provide a port number");
    return;
  }
  if (Integer.valueOf(txtPort.getText()) < 1 || Integer.valueOf(txtPort.getText()) > 65535) {
    JOptionPane.showMessageDialog(rootPane,"Invalid port number");
    txtPort.setText(MageFrame.getPreferences().get("serverPort",Integer.toString(Config.port)));
    return;
  }
  char[] input=new char[0];
  try {
    setCursor(Cursor.getPredefinedCursor(Cursor.WAIT_CURSOR));
    connection=new Connection();
    connection.setHost(this.txtServer.getText().trim());
    connection.setPort(Integer.valueOf(this.txtPort.getText().trim()));
    connection.setUsername(this.txtUserName.getText().trim());
    ProxyType configProxyType=Connection.ProxyType.valueByText(PreferencesDialog.getCachedValue(PreferencesDialog.KEY_PROXY_TYPE,"None"));
    if (configProxyType != null) {
      connection.setProxyType(configProxyType);
      if (!configProxyType.equals(ProxyType.NONE)) {
        String host=PreferencesDialog.getCachedValue(PreferencesDialog.KEY_PROXY_ADDRESS,"");
        String port=PreferencesDialog.getCachedValue(PreferencesDialog.KEY_PROXY_PORT,"");
        if (!host.isEmpty() && !port.isEmpty()) {
          connection.setProxyHost(host);
          connection.setProxyPort(Integer.valueOf(port));
          String username=PreferencesDialog.getCachedValue(PreferencesDialog.KEY_PROXY_USERNAME,"");
          connection.setProxyUsername(username);
          if (PreferencesDialog.getCachedValue(PreferencesDialog.KEY_PROXY_REMEMBER,"false").equals("true")) {
            String password=PreferencesDialog.getCachedValue(PreferencesDialog.KEY_PROXY_PSWD,"");
            connection.setProxyPassword(password);
          }
        }
 else {
          logger.warn("host or\\and port are empty: host=" + host + ", port="+ port);
        }
      }
    }
    int avatarId=PreferencesDialog.getSelectedAvatar();
    connection.setAvatarId(avatarId);
    boolean showAbilityPickerForced=PreferencesDialog.getCachedValue(PreferencesDialog.KEY_SHOW_ABILITY_PICKER_FORCED,"true").equals("true");
    connection.setShowAbilityPickerForced(showAbilityPickerForced);
    logger.debug("connecting: " + connection.getProxyType() + " "+ connection.getProxyHost()+ " "+ connection.getProxyPort());
    task=new ConnectTask();
    task.execute();
  }
  finally {
    Arrays.fill(input,'0');
  }
}
