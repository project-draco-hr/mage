{
  HashSet<Ability> set=effectAbilityMap.get(effect.getId());
  Iterator<Ability> it=set.iterator();
  while (it.hasNext()) {
    Ability ability=it.next();
    if (ability == null) {
      it.remove();
    }
 else     if (effect.isDiscarded()) {
      it.remove();
    }
 else {
switch (effect.getDuration()) {
case WhileOnBattlefield:
        if (game.getObject(ability.getSourceId()) == null) {
          it.remove();
        }
      break;
case OneUse:
    if (effect.isUsed()) {
      it.remove();
    }
  break;
case Custom:
case UntilYourNextTurn:
if (effect.isInactive(ability,game)) {
  it.remove();
}
}
}
}
return set.isEmpty();
}
