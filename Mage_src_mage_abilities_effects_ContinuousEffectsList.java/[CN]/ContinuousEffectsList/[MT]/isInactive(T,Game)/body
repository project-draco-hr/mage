{
  HashSet<Ability> set=effectAbilityMap.get(effect.getId());
  Iterator it=set.iterator();
  while (it.hasNext()) {
    Ability ability=(Ability)it.next();
    if (ability == null) {
      it.remove();
    }
 else     if (effect.isDiscarded()) {
      it.remove();
    }
 else {
switch (effect.getDuration()) {
case WhileOnBattlefield:
        if (game.getObject(ability.getSourceId()) == null) {
          it.remove();
        }
case OneUse:
      if (effect.isUsed()) {
        it.remove();
      }
case Custom:
    if (effect.isInactive(ability,game)) {
      it.remove();
    }
}
}
}
return set.isEmpty();
}
