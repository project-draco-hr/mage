{
  updateGameStatePriority("chooseMode",game);
  if (modes.size() > 1) {
    MageObject obj=game.getObject(source.getSourceId());
    Map<UUID,String> modeMap=new LinkedHashMap<>();
    for (    Mode mode : modes.getAvailableModes(source,game)) {
      if ((!modes.getSelectedModes().contains(mode.getId()) || modes.isEachModeMoreThanOnce()) && mode.getTargets().canChoose(source.getSourceId(),source.getControllerId(),game)) {
        String modeText=mode.getEffects().getText(mode);
        if (obj != null) {
          modeText=modeText.replace("{source}",obj.getName()).replace("{this}",obj.getName());
        }
        if (modes.isEachModeMoreThanOnce()) {
          int timesSelected=0;
          for (          UUID selectedModeId : modes.getSelectedModes()) {
            if (mode.getId().equals(selectedModeId)) {
              timesSelected++;
            }
          }
          if (timesSelected > 0) {
            modeText="(selected " + timesSelected + "x) "+ modeText;
          }
        }
        modeMap.put(mode.getId(),modeText);
      }
    }
    if (modeMap.size() > 0) {
      boolean done=false;
      while (!done) {
        game.fireGetModeEvent(playerId,"Choose Mode",modeMap);
        waitForResponse(game);
        if (response.getUUID() != null) {
          for (          Mode mode : modes.getAvailableModes(source,game)) {
            if (mode.getId().equals(response.getUUID())) {
              return mode;
            }
          }
        }
        if (!source.getAbilityType().equals(AbilityType.TRIGGERED)) {
          done=true;
        }
        if (!canRespond()) {
          return null;
        }
      }
    }
    return null;
  }
  return modes.getMode();
}
