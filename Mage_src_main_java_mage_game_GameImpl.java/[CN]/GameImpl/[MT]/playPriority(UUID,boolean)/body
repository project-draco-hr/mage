{
  int errorContinueCounter=0;
  int bookmark=0;
  clearAllBookmarks();
  try {
    applyEffects();
    while (!isPaused() && !gameOver(null) && !this.getTurn().isEndTurnRequested()) {
      if (!resuming) {
        state.getPlayers().resetPassed();
        state.getPlayerList().setCurrent(activePlayerId);
      }
 else {
        state.getPlayerList().setCurrent(this.getPriorityPlayerId());
      }
      fireUpdatePlayersEvent();
      Player player;
      while (!isPaused() && !gameOver(null)) {
        try {
          if (bookmark == 0) {
            bookmark=bookmarkState();
          }
          player=getPlayer(state.getPlayerList().get());
          state.setPriorityPlayerId(player.getId());
          while (!player.isPassed() && player.canRespond() && !isPaused()&& !gameOver(null)) {
            if (!resuming) {
              checkStateAndTriggered();
              applyEffects();
              if (state.getStack().isEmpty()) {
                resetLKI();
              }
              saveState(false);
              if (isPaused() || gameOver(null)) {
                return;
              }
              if (player.priority(this)) {
                if (executingRollback()) {
                  return;
                }
                applyEffects();
              }
              if (isPaused()) {
                return;
              }
            }
            resuming=false;
          }
          resetShortLivingLKI();
          resuming=false;
          if (isPaused() || gameOver(null)) {
            return;
          }
          if (allPassed()) {
            if (!state.getStack().isEmpty()) {
              resolve();
              applyEffects();
              state.getPlayers().resetPassed();
              fireUpdatePlayersEvent();
              resetShortLivingLKI();
              break;
            }
 else {
              resetLKI();
              return;
            }
          }
        }
 catch (        Exception ex) {
          logger.fatal("Game exception gameId: " + getId(),ex);
          if ((ex instanceof NullPointerException) && errorContinueCounter == 1 && ex.getStackTrace() != null) {
            logger.fatal(ex.getStackTrace());
          }
          this.fireErrorEvent("Game exception occurred: ",ex);
          restoreState(bookmark,"");
          bookmark=0;
          Player activePlayer=this.getPlayer(getActivePlayerId());
          if (errorContinueCounter > 15) {
            throw new MageException("Iterated player priority after game exception too often, game ends!");
          }
          if (activePlayer != null && !activePlayer.isTestMode()) {
            errorContinueCounter++;
            continue;
          }
 else {
            throw new MageException("Error in testclass");
          }
        }
        state.getPlayerList().getNext();
      }
    }
  }
 catch (  Exception ex) {
    logger.fatal("Game exception ",ex);
    this.fireErrorEvent("Game exception occurred: ",ex);
    this.end();
  }
 finally {
    resetLKI();
    clearAllBookmarks();
  }
}
