{
  sessionState=SessionState.CONNECTING;
  try {
    InvokerLocator clientLocator=new InvokerLocator(connection.getURI());
    Map<String,String> metadata=new HashMap<String,String>();
    metadata.put(SocketWrapper.WRITE_TIMEOUT,"2000");
    metadata.put("generalizeSocketException","true");
    server=(MageServer)TransporterClient.createTransporterClient(clientLocator.getLocatorURI(),MageServer.class,metadata);
    callbackClient=new Client(clientLocator,"callback");
    callbackClient.connect();
    Map<String,String> listenerMetadata=new HashMap<String,String>();
    listenerMetadata.put(ConnectionValidator.VALIDATOR_PING_PERIOD,"5000");
    listenerMetadata.put(ConnectionValidator.VALIDATOR_PING_TIMEOUT,"2000");
    callbackClient.addConnectionListener(new ClientConnectionListener(),listenerMetadata);
    Map<String,String> callbackMetadata=new HashMap<String,String>();
    callbackMetadata.put(Bisocket.IS_CALLBACK_SERVER,"true");
    callbackMetadata.put(SocketWrapper.WRITE_TIMEOUT,"2000");
    callbackMetadata.put("generalizeSocketException","true");
    CallbackHandler callbackHandler=new CallbackHandler();
    callbackClient.addListener(callbackHandler,callbackMetadata);
    this.sessionId=callbackClient.getSessionId();
    boolean registerResult=false;
    if (connection.getPassword() == null)     registerResult=server.registerClient(connection.getUsername(),sessionId,client.getVersion());
 else     registerResult=server.registerAdmin(connection.getPassword(),sessionId,client.getVersion());
    if (registerResult) {
      sessionState=SessionState.CONNECTED;
      serverState=server.getServerState();
      logger.info("Connected to MAGE server at " + connection.getHost() + ":"+ connection.getPort());
      client.connected("Connected to " + connection.getHost() + ":"+ connection.getPort()+ " ");
      return true;
    }
    disconnect(false);
    client.showMessage("Unable to connect to server.");
  }
 catch (  MalformedURLException ex) {
    logger.fatal("",ex);
    client.showMessage("Unable to connect to server. " + ex.getMessage());
  }
catch (  Throwable t) {
    logger.fatal("Unable to connect to server - ",t);
    disconnect(false);
    client.showMessage("Unable to connect to server. " + t.getMessage());
  }
  return false;
}
