{
  if (log.isDebugEnabled()) {
    log.debug("chooseTarget: " + outcome.toString() + ":"+ target.toString());
  }
  UUID abilityControllerId=playerId;
  if (target.getAbilityController() != null) {
    abilityControllerId=target.getAbilityController();
  }
  UUID randomOpponentId=getRandomOpponent(abilityControllerId,game);
  if (target instanceof TargetPlayer) {
    return setTargetPlayer(outcome,target,source,source.getSourceId(),abilityControllerId,randomOpponentId,game);
  }
  if (target instanceof TargetDiscard || target instanceof TargetCardInHand) {
    if (outcome.isGood()) {
      Cards cards=new CardsImpl(target.possibleTargets(source.getSourceId(),getId(),game));
      ArrayList<Card> cardsInHand=new ArrayList<>(cards.getCards(game));
      while (!target.isChosen() && target.possibleTargets(source.getSourceId(),getId(),game).size() > 0 && target.getMaxNumberOfTargets() > target.getTargets().size()) {
        Card card=pickBestCard(cardsInHand,null,target,source,game);
        if (card != null) {
          if (target.canTarget(getId(),card.getId(),source,game)) {
            target.addTarget(card.getId(),source,game);
            cardsInHand.remove(card);
            if (target.isChosen()) {
              return true;
            }
          }
        }
      }
    }
 else {
      findPlayables(game);
      if (unplayable.size() > 0) {
        for (int i=unplayable.size() - 1; i >= 0; i--) {
          if (target.canTarget(getId(),unplayable.values().toArray(new Card[0])[i].getId(),source,game)) {
            target.addTarget(unplayable.values().toArray(new Card[0])[i].getId(),source,game);
            if (target.isChosen()) {
              return true;
            }
          }
        }
      }
      if (hand.size() > 0) {
        for (int i=0; i < hand.size(); i++) {
          if (target.canTarget(getId(),hand.toArray(new UUID[0])[i],source,game)) {
            target.addTarget(hand.toArray(new UUID[0])[i],source,game);
            if (target.isChosen()) {
              return true;
            }
          }
        }
      }
    }
    return false;
  }
  if (target instanceof TargetControlledPermanent) {
    List<Permanent> targets;
    targets=threats(abilityControllerId,source.getSourceId(),((TargetControlledPermanent)target).getFilter(),game,target.getTargets());
    if (!outcome.isGood()) {
      Collections.reverse(targets);
    }
    for (    Permanent permanent : targets) {
      if (((TargetControlledPermanent)target).canTarget(abilityControllerId,permanent.getId(),source,game)) {
        target.addTarget(permanent.getId(),source,game);
        if (target.getNumberOfTargets() <= target.getTargets().size() && (!outcome.isGood() || target.getMaxNumberOfTargets() <= target.getTargets().size())) {
          return true;
        }
      }
    }
    return target.isChosen();
  }
  if (target instanceof TargetPermanent) {
    List<Permanent> targets;
    boolean outcomeTargets=true;
    if (outcome.isGood()) {
      targets=threats(abilityControllerId,source == null ? null : source.getSourceId(),((TargetPermanent)target).getFilter(),game,target.getTargets());
    }
 else {
      targets=threats(randomOpponentId,source == null ? null : source.getSourceId(),((TargetPermanent)target).getFilter(),game,target.getTargets());
    }
    if (targets.isEmpty() && target.isRequired(source)) {
      targets=threats(null,source == null ? null : source.getSourceId(),((TargetPermanent)target).getFilter(),game,target.getTargets());
      Collections.reverse(targets);
      outcomeTargets=false;
    }
    for (    Permanent permanent : targets) {
      if (((TargetPermanent)target).canTarget(abilityControllerId,permanent.getId(),source,game)) {
        target.addTarget(permanent.getId(),source,game);
        if (!outcomeTargets || target.getMaxNumberOfTargets() <= target.getTargets().size()) {
          return true;
        }
      }
    }
    return target.isChosen();
  }
  if (target instanceof TargetCreatureOrPlayer) {
    List<Permanent> targets;
    TargetCreatureOrPlayer t=((TargetCreatureOrPlayer)target);
    if (outcome.isGood()) {
      targets=threats(abilityControllerId,source.getSourceId(),((FilterCreatureOrPlayer)t.getFilter()).getCreatureFilter(),game,target.getTargets());
    }
 else {
      targets=threats(randomOpponentId,source.getSourceId(),((FilterCreatureOrPlayer)t.getFilter()).getCreatureFilter(),game,target.getTargets());
    }
    if (targets.isEmpty()) {
      if (outcome.isGood()) {
        if (target.canTarget(getId(),abilityControllerId,source,game)) {
          target.addTarget(abilityControllerId,source,game);
          return true;
        }
      }
 else {
        if (target.canTarget(getId(),randomOpponentId,source,game)) {
          target.addTarget(randomOpponentId,source,game);
          return true;
        }
      }
    }
    if (targets.isEmpty() && target.isRequired(source)) {
      targets=game.getBattlefield().getActivePermanents(((FilterCreatureOrPlayer)t.getFilter()).getCreatureFilter(),playerId,game);
    }
    for (    Permanent permanent : targets) {
      List<UUID> alreadyTargetted=target.getTargets();
      if (t.canTarget(abilityControllerId,permanent.getId(),source,game)) {
        if (alreadyTargetted != null && !alreadyTargetted.contains(permanent.getId())) {
          target.addTarget(permanent.getId(),source,game);
          return true;
        }
      }
    }
    if (outcome.isGood()) {
      if (target.canTarget(getId(),abilityControllerId,source,game)) {
        target.addTarget(abilityControllerId,source,game);
        return true;
      }
    }
 else {
      if (target.canTarget(getId(),randomOpponentId,source,game)) {
        target.addTarget(randomOpponentId,source,game);
        return true;
      }
    }
    return false;
  }
  if (target instanceof TargetCardInGraveyard) {
    List<Card> cards=new ArrayList<>();
    for (    Player player : game.getPlayers().values()) {
      cards.addAll(player.getGraveyard().getCards(game));
    }
    Card card=pickTarget(cards,outcome,target,source,game);
    if (card != null) {
      target.addTarget(card.getId(),source,game);
      return true;
    }
    return false;
  }
  if (target instanceof TargetCardInLibrary) {
    List<Card> cards=new ArrayList<>(game.getPlayer(abilityControllerId).getLibrary().getCards(game));
    Card card=pickTarget(cards,outcome,target,source,game);
    if (card != null) {
      target.addTarget(card.getId(),source,game);
      return true;
    }
    return false;
  }
  if (target instanceof TargetCardInYourGraveyard) {
    List<Card> cards=new ArrayList<>(game.getPlayer(abilityControllerId).getGraveyard().getCards(game));
    while (!target.isChosen() && !cards.isEmpty()) {
      Card card=pickTarget(cards,outcome,target,source,game);
      if (card != null) {
        target.addTarget(card.getId(),source,game);
      }
    }
    return target.isChosen();
  }
  if (target instanceof TargetSpell) {
    if (game.getStack().size() > 0) {
      Iterator<StackObject> it=game.getStack().iterator();
      while (it.hasNext()) {
        StackObject o=it.next();
        if (o instanceof Spell && !source.getId().equals(o.getStackAbility().getId())) {
          target.addTarget(o.getId(),source,game);
          return true;
        }
      }
    }
    return false;
  }
  if (target instanceof TargetSpellOrPermanent) {
    List<Permanent> targets;
    boolean outcomeTargets=true;
    if (outcome.isGood()) {
      targets=threats(abilityControllerId,source == null ? null : source.getSourceId(),((TargetSpellOrPermanent)target).getPermanentFilter(),game,target.getTargets());
    }
 else {
      targets=threats(randomOpponentId,source == null ? null : source.getSourceId(),((TargetSpellOrPermanent)target).getPermanentFilter(),game,target.getTargets());
    }
    if (targets.isEmpty() && target.isRequired(source)) {
      targets=threats(null,source == null ? null : source.getSourceId(),((TargetSpellOrPermanent)target).getPermanentFilter(),game,target.getTargets());
      Collections.reverse(targets);
      outcomeTargets=false;
    }
    for (    Permanent permanent : targets) {
      if (((TargetSpellOrPermanent)target).canTarget(abilityControllerId,permanent.getId(),source,game)) {
        target.addTarget(permanent.getId(),source,game);
        if (!outcomeTargets || target.getMaxNumberOfTargets() <= target.getTargets().size()) {
          return true;
        }
      }
    }
    if (game.getStack().size() > 0) {
      Iterator<StackObject> it=game.getStack().iterator();
      while (it.hasNext()) {
        StackObject stackObject=it.next();
        if (stackObject instanceof Spell && source != null && !source.getId().equals(stackObject.getStackAbility().getId())) {
          if (((TargetSpellOrPermanent)target).getFilter().match(stackObject,game)) {
            target.addTarget(stackObject.getId(),source,game);
            return true;
          }
        }
      }
    }
    return false;
  }
  if (target instanceof TargetCardInOpponentsGraveyard) {
    List<Card> cards=new ArrayList<>();
    for (    UUID uuid : game.getOpponents(abilityControllerId)) {
      Player player=game.getPlayer(uuid);
      if (player != null) {
        cards.addAll(player.getGraveyard().getCards(game));
      }
    }
    Card card=pickTarget(cards,outcome,target,source,game);
    if (card != null) {
      target.addTarget(card.getId(),source,game);
      return true;
    }
    return false;
  }
  if (target instanceof TargetDefender) {
    List<Permanent> targets;
    targets=game.getBattlefield().getActivePermanents(new FilterPlaneswalkerPermanent(),randomOpponentId,game);
    if (targets != null && !targets.isEmpty()) {
      for (      Permanent planeswalker : targets) {
        if (target.canTarget(getId(),planeswalker.getId(),source,game)) {
          target.addTarget(planeswalker.getId(),source,game);
        }
        if (target.isChosen()) {
          return true;
        }
      }
    }
    if (!target.isChosen()) {
      if (target.canTarget(getId(),randomOpponentId,source,game)) {
        target.addTarget(randomOpponentId,source,game);
      }
    }
    return target.isChosen();
  }
  if (target instanceof TargetCardInASingleGraveyard) {
    List<Card> cards=new ArrayList<>();
    for (    Player player : game.getPlayers().values()) {
      cards.addAll(player.getGraveyard().getCards(game));
    }
    while (!target.isChosen() && !cards.isEmpty()) {
      Card pick=pickTarget(cards,outcome,target,source,game);
      if (pick != null) {
        target.addTarget(pick.getId(),source,game);
      }
    }
    return target.isChosen();
  }
  if (target instanceof TargetCardInExile) {
    List<Card> cards=new ArrayList<>();
    for (    UUID uuid : ((TargetCardInExile)target).possibleTargets(source.getSourceId(),source.getControllerId(),game)) {
      Card card=game.getCard(uuid);
      if (card != null) {
        cards.add(card);
      }
    }
    while (!target.isChosen() && !cards.isEmpty()) {
      Card pick=pickTarget(cards,outcome,target,source,game);
      if (pick != null) {
        target.addTarget(pick.getId(),source,game);
      }
    }
    return target.isChosen();
  }
  throw new IllegalStateException("Target wasn't handled. class:" + target.getClass().toString());
}
