{
  if (!ConfigSettings.getInstance().isAuthenticationActivated()) {
    return "Registration is disabled by the server config.";
  }
synchronized (AuthorizedUserRepository.instance) {
    String returnMessage=validateUserName(userName);
    if (returnMessage != null) {
      sendErrorMessageToClient(returnMessage);
      return returnMessage;
    }
    returnMessage=validatePassword(password);
    if (returnMessage != null) {
      sendErrorMessageToClient(returnMessage);
      return returnMessage;
    }
    AuthorizedUserRepository.instance.add(userName,password,email);
    if (GmailClient.sendMessage(email,"XMage Registration Completed","You are successfully registered as " + userName + ".")) {
      logger.info("Sent a registration confirmation email to " + email + " for "+ userName);
    }
 else {
      logger.error("Failed sending a registration confirmation email to " + email + " for "+ userName);
    }
    return null;
  }
}
