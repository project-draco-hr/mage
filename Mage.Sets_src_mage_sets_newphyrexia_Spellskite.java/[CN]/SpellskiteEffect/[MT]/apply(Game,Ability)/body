{
  StackObject stackObject=game.getStack().getStackObject(source.getFirstTarget());
  MageObject sourceObject=game.getObject(source.getSourceId());
  if (stackObject != null && sourceObject != null) {
    Targets targets=new Targets();
    Ability sourceAbility;
    MageObject oldTarget=null;
    if (stackObject instanceof Spell) {
      Spell spell=(Spell)stackObject;
      sourceAbility=spell.getSpellAbility();
    }
 else     if (stackObject instanceof StackAbility) {
      StackAbility stackAbility=(StackAbility)stackObject;
      sourceAbility=stackAbility;
    }
 else {
      return false;
    }
    for (    UUID modeId : sourceAbility.getModes().getSelectedModes()) {
      sourceAbility.getModes().setActiveMode(modeId);
      targets.addAll(sourceAbility.getTargets());
    }
    boolean twoTimesTarget=false;
    if (targets.size() == 1 && targets.get(0).getTargets().size() == 1) {
      Target target=targets.get(0);
      if (target.canTarget(stackObject.getControllerId(),source.getSourceId(),sourceAbility,game)) {
        oldTarget=game.getObject(targets.getFirstTarget());
        target.clearChosen();
        target.addTarget(source.getSourceId(),stackObject.getStackAbility(),game);
      }
    }
 else {
      Player player=game.getPlayer(source.getControllerId());
      for (      Target target : targets) {
        for (        UUID targetId : target.getTargets()) {
          MageObject object=game.getObject(targetId);
          String name;
          if (object == null) {
            Player targetPlayer=game.getPlayer(targetId);
            name=targetPlayer.getLogName();
          }
 else {
            name=object.getLogName();
          }
          if (!targetId.equals(source.getSourceId()) && target.getTargets().contains(source.getSourceId())) {
            twoTimesTarget=true;
            continue;
          }
          if (name != null && player.chooseUse(Outcome.Neutral,"Change target from " + name + " to "+ sourceObject.getLogName()+ "?",source,game)) {
            if (target.canTarget(stackObject.getControllerId(),source.getSourceId(),sourceAbility,game)) {
              oldTarget=game.getObject(targets.getFirstTarget());
              target.remove(targetId);
              target.addTarget(source.getSourceId(),stackObject.getStackAbility(),game);
              break;
            }
          }
        }
      }
    }
    if (oldTarget != null) {
      game.informPlayers(sourceObject.getLogName() + ": Changed target of " + stackObject.getLogName()+ " from "+ oldTarget.getLogName()+ " to "+ sourceObject.getLogName());
    }
 else {
      if (twoTimesTarget) {
        game.informPlayers(sourceObject.getLogName() + ": Target not changed to " + sourceObject.getLogName()+ " because its not valid to target it twice for "+ stackObject.getLogName());
      }
 else {
        game.informPlayers(sourceObject.getLogName() + ": Target not changed to " + sourceObject.getLogName()+ " because its no valid target for "+ stackObject.getLogName());
      }
    }
    return true;
  }
  return false;
}
