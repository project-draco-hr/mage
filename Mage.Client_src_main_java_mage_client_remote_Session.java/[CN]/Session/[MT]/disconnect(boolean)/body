{
  sessionState=SessionState.DISCONNECTING;
  if (connection == null)   return;
  if (future != null && !future.isDone())   future.cancel(true);
  frame.setStatusText("Not connected");
  frame.disableButtons();
  try {
    for (    UUID chatId : chats.keySet()) {
      leaveChat(chatId);
    }
  }
 catch (  Exception ignore) {
  }
  try {
    if (callbackDaemon != null)     callbackDaemon.stopDaemon();
    deregisterClient();
  }
 catch (  MageException ex) {
    logger.fatal("Error disconnecting ...",ex);
  }
  ServerCache.removeServerFromCache(connection);
  frame.hideGames();
  frame.hideTables();
  logger.info("Disconnected ... ");
  if (!voluntary)   JOptionPane.showMessageDialog(MageFrame.getDesktop(),"Server error.  You have been disconnected","Error",JOptionPane.ERROR_MESSAGE);
}
