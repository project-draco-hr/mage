{
  for (Iterator<ContinuousEffect> i=layeredEffects.keySet().iterator(); i.hasNext(); ) {
    ContinuousEffect entry=i.next();
    if (entry.getDuration() == Duration.WhileOnBattlefield) {
      Permanent permanent=game.getPermanent(layeredEffects.get(entry).getSourceId());
      if (permanent == null || !permanent.isPhasedIn())       i.remove();
    }
 else     if (entry.getDuration() == Duration.OneUse && entry.isUsed())     i.remove();
  }
  for (Iterator<ReplacementEffect> i=replacementEffects.keySet().iterator(); i.hasNext(); ) {
    ReplacementEffect entry=i.next();
    if (entry.getDuration() == Duration.WhileOnBattlefield) {
      Permanent permanent=game.getPermanent(replacementEffects.get(entry).getSourceId());
      if (permanent == null || !permanent.isPhasedIn())       i.remove();
    }
 else     if (entry.getDuration() == Duration.OneUse && entry.isUsed())     i.remove();
  }
  for (Iterator<PreventionEffect> i=preventionEffects.keySet().iterator(); i.hasNext(); ) {
    PreventionEffect entry=i.next();
    if (entry.getDuration() == Duration.WhileOnBattlefield) {
      Permanent permanent=game.getPermanent(preventionEffects.get(entry).getSourceId());
      if (permanent == null || !permanent.isPhasedIn())       i.remove();
    }
 else     if (entry.getDuration() == Duration.OneUse && entry.isUsed())     i.remove();
  }
  for (Iterator<AsThoughEffect> i=asThoughEffects.keySet().iterator(); i.hasNext(); ) {
    AsThoughEffect entry=i.next();
    if (entry.getDuration() == Duration.WhileOnBattlefield) {
      Permanent permanent=game.getPermanent(asThoughEffects.get(entry).getSourceId());
      if (permanent == null || !permanent.isPhasedIn())       i.remove();
    }
 else     if (entry.getDuration() == Duration.OneUse && entry.isUsed())     i.remove();
  }
}
