{
  for (  Permanent permanent : game.getBattlefield().getActivePermanents(new FilterPermanent(),source.getControllerId(),source.getSourceId(),game)) {
    permanent.moveToZone(Zone.HAND,source.getSourceId(),game,false);
  }
  game.informPlayers("Worldpurge: All permanents returned to owners' hands");
  for (  Player player : game.getPlayers().values()) {
    if (player != null) {
      Cards hand=player.getHand();
      FilterCard filter=new FilterCard("card to keep in hand");
      filter.add(new OwnerIdPredicate(player.getId()));
      int numberInHand=Math.min(7,hand.size());
      TargetCardInHand target=new TargetCardInHand(0,numberInHand,filter);
      if (player.choose(Outcome.Benefit,target,source.getSourceId(),game)) {
        for (        Card card : hand.getCards(game)) {
          if (!target.getTargets().contains(card.getId())) {
            card.moveToZone(Zone.LIBRARY,source.getSourceId(),game,false);
          }
        }
      }
      player.shuffleLibrary(game);
    }
  }
  game.emptyManaPools();
  game.informPlayers("Worldpurge: All mana pools have been emptied");
  return true;
}
